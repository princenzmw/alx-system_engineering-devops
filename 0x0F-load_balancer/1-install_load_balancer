#!/usr/bin/env bash
# A bash script that Install and configure HAproxy on lb-01 server
# Configure HAProxy to send traffic to web-01 and web-02 servers
# Distribute requests using a roundrobin algorithm
# Make sure that HAProxy can be managed via an init script

# Variables representing the backend servers
WEB01="35.153.67.87"
WEB02="100.26.240.141"

# Update package index
sudo apt-get update

# Install HAProxy.
sudo apt-get -y install haproxy

# Enable HAProxy to start on boot
# systemctl enable haproxy
sudo service haproxy enable

# Configuring HAProxy
cat > /etc/haproxy/haproxy.cfg <<EOF
global
    log /dev/log    local0
    log /dev/log    local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5000ms
    timeout client  50000ms
    timeout server  50000ms

# Define frontend configuration
frontend http_front
   bind *:80
   stats uri /haproxy?stats
   default_backend http_back

# Define backend configuration
backend http_back
    balance roundrobin
    server 462126-web-01 $WEB01:80 check
    server 462126-web-02 $WEB02:80 check
EOF

# enable haproxy to be started by init script
echo "ENABLED=1" | sudo tee -a /etc/default/haproxy

# Testing the HAproxy configuration file
sudo haproxy -c -V -f /etc/haproxy/haproxy.cfg

# Restart the Nginx service
sudo service haproxy restart
